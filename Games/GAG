-- Load Avantrix Library
local lib = loadstring(game:HttpGet("https://raw.githubusercontent.com/xenlua/Xens/refs/heads/main/ui/Avantrix.lua"))() 
local FlagsManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/xenlua/Xens/refs/heads/main/ui/Flags"))()

local LPH_JIT_MAX = function(...) return(...) end;
local LPH_NO_VIRTUALIZE = function(...) return(...) end;
local LPH_CRASH = function(...) while task.wait() do game:GetService("ScriptContext"):SetTimeout(math.huge);while true do while true do while true do while true do while true do while true do while true do while true do print("noob") end end end end end end end end end end;
local LRM_UserNote = "Owner"
local LRM_ScriptVersion = "v20"
local ClonedPrint = print

if LPH_OBFUSCATED then
    ClonedPrint = print
    print = function(...)end
    warn = function(...)end

    local PreventSkidsToMakeGayThings = loadstring(game:HttpGet("https://raw.githubusercontent.com/Hosvile/InfiniX/a40a158d22fd4f4733beb2f67379866ccb17906f/Library/Anti/AntiDebug/main.lua", true))()

    if not (type(PreventSkidsToMakeGayThings) == "table") then
        LPH_CRASH()
    end
end

repeat task.wait() until game.Players.LocalPlayer and game.Players.LocalPlayer.Character

if not game:IsLoaded() then
    game.Loaded:Wait()
end

-- Gradient function
function gradient(text)
    return text -- Simplified for now
end

-- Format version function
function formatVersion(version)
    local formattedVersion = "v" .. version:sub(2):gsub(".", "%0.")
    return formattedVersion:sub(1, #formattedVersion - 1)
end

-- Initialize main GUI
local main = lib:Load({
    Title = 'GAG '..formatVersion(LRM_ScriptVersion)..' | ' .. gradient("Avantrix").. " | ",
    ToggleButton = "rbxassetid://100227182680708",
})

-- Game Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

-- Variables
local LocalPlayer = Players.LocalPlayer

-- TrowelRemote detection
local TrowelRemote = ReplicatedStorage:FindFirstChild("GameEvents") and ReplicatedStorage.GameEvents:FindFirstChild("TrowelRemote")

-- Create tabs
local tabs = {
    Welcome = main:AddTab("Information"),
    Main = main:AddTab("Main"),
    Auto = main:AddTab("Auto"),
    Shop = main:AddTab("Shop"),
    Event = main:AddTab("Event"),
    Settings = main:AddTab("Settings"),
}

main:SelectTab()

-- Create sections
local sections = {
    Welcome = tabs.Welcome:AddSection({Defualt = true, Locked = true}),
    SeedBuyer = tabs.Shop:AddSection({Title = "Seed Purchasing", Description = "Auto buy seeds", Defualt = true, Locked = false}),
    GearBuyer = tabs.Shop:AddSection({Title = "Gear Purchasing", Description = "Auto buy gears", Defualt = true, Locked = false}),
    Teleport = tabs.Main:AddSection({Title = "Teleport", Description = "Teleportation utilities", Defualt = true, Locked = false}),
    Fruit = tabs.Main:AddSection({Title = "Fruit Management", Description = "Fruit collection and selling", Defualt = false, Locked = false}),
    AutoHarvest = tabs.Main:AddSection({Title = "Mutasi Collection", Description = "Collect fruits with specific mutations", Defualt = false, Locked = false}),
    MovePlants = tabs.Auto:AddSection({Title = "Move Plants", Description = "Automatically move all plants to selected pet", Defualt = true, Locked = false}),
    UIControls = tabs.Shop:AddSection({Title = "UI Controls", Description = "Toggle game UIs", Defualt = true, Locked = false}),
    NPCSubmission = tabs.Event:AddSection({Title = "Zen Event", Description = "Submit plants to NPCs", Defualt = true, Locked = false}),
}

-- Variables
local var = {}

-- Initialize welcome paragraph
var.WelcomeParagraph = sections.Welcome:AddParagraph({
    Title = gradient("Loading..."), 
    Description = "Please wait..\nIf you've been stuck on this for a long time please join our discord and report it.\nYou could also try:\n- Re-execute\n- Rejoin"
})

var.WelcomeParagraph:SetTitle(gradient("Welcome to GAG Hub!"))
var.WelcomeParagraph:SetDesc([[<font color="rgb(255,255,255)">NEWS:</font>


<b><font color='rgb(255, 255, 255)'>----------------------------------------[Features]--------------------------------------</font></b>

<font color="rgb(255,255,255)">Version:</font> ]] .. formatVersion(LRM_ScriptVersion) .. [[

<font color="rgb(255,255,255)">Features:</font>


<font color="rgb(255,255,255)">Instructions:</font>
1. Select plants from dropdown (multiple selection)
2. Select pet from available pets (auto-detected from UI)
3. Enable Move Plants to start farming
4. Script will automatically find YOUR farm and pets
5. Join our Discord for support

<font color="rgb(255,255,255)">Discord:</font> discord.gg/cF8YeDPt2G]])

-- Add Discord button
sections.Welcome:AddButton({
    Title = "Copy Discord Link",
    Callback = function()
        setclipboard("https://discord.gg/cF8YeDPt2G")
        lib:Dialog({
            Title = "Success",
            Content = "Discord link copied to clipboard!",
            Buttons = {
                {
                    Title = "OK",
                    Variant = "Primary",
                    Callback = function() end,
                }
            }
        })
    end,
})

-- Variables
local autoSubmit = false
local autoSubmitAllHarvest = false
local fruitThreshold = 10
local autoSell = false
local highlightToggle = false
local currentHighlight = nil
local currentBillboard = nil
local lastBiggest = nil
local savedPosition = nil
local antiAfkEnabled = false
local afkConnection
local mutasiCollectEnabled = false
local infiniteJump = false

-- NEW: Mutasi Collection Variables
local selectedMutasi = {}

-- SIMPLIFIED: Move Plants Variables
local selectedPlants = {} -- Plants selected from dropdown
local selectedPetName = nil -- Selected pet name from dropdown
local movePlantsEnabled = false

-- NPC Submission Variables
local selectedNPC = nil
local autoSubmitToNPC = false

-- FIXED: Valid Mutasi list based on the image attributes
local validMutasi = {
    "Tranquil",
    "Chakra",
    "Foxfire Chakra",
    "Radioactive",
    "Twisted",
    "Shocked",
    "Celestial", 
    "Aurora",
    "Drenched",
    "Sandy",
    "Plasma",
    "Dawnbound",
    "Gold",
    "Rainbow",
    "Wet",
    "Chilled",
    "Pollinated",
    "HoneyGlazed",
    "Voidtouched",
    "Friendbound",
    "Eclipsed",
    "Moonlit" -- Added from the image
}

-- Seed Buying Variables
local validSeeds = {
    "Carrot", "Strawberry", "Blueberry", "Tomato", "Orange Tulip", "Corn", 
    "Daffodil", "Watermelon", "Pumpkin", "Apple", "Bamboo", "Coconut", 
    "Cactus", "Dragon Fruit", "Mango", "Grape","Mushroom","Pepper","Cacao","Beanstalk","Ember Lily","Sugar Apple","Burning Bud"
}
local selectedSeeds = {}
local autoBuyingSelected = false
local autoBuyingAll = false

-- Gear Buying Variables
local validGears = {
    "Basic Sprinkler", "Advanced Sprinkler", "Godly Sprinkler",
    "Master Sprinkler", "Recall Wrench", "Tanning Mirror", "Trowel", "Watering Can", "Harvest Tool", "Friendship Pot", "Cleaning Spray","Medium Toy", "Medium Treat","Levelup Lollipop"
}
local selectedGears = {}
local autoBuyingSelectedGear = false
local autoBuyingAllGears = false

-- Available NPCs for submission
local availableNPCs = {
    "Channeller",
    "Zen Shop"
}

-- Get RemoteEvents
local rs = ReplicatedStorage
local buyEvent = rs:FindFirstChild("GameEvents") and rs.GameEvents:FindFirstChild("BuySeedStock")
local buyGearEvent = rs:FindFirstChild("GameEvents") and rs.GameEvents:FindFirstChild("BuyGearStock")

-- NPC RemoteEvents
local ZenQuestRemoteEvent = rs:FindFirstChild("GameEvents") and rs.GameEvents:FindFirstChild("ZenQuestRemoteEvent")
local ZenAuraRemoteEvent = rs:FindFirstChild("GameEvents") and rs.GameEvents:FindFirstChild("ZenAuraRemoteEvent")

game:GetService("Players").LocalPlayer.PlayerGui.Teleport_UI.Frame.Gear.Visible = true
game:GetService("Players").LocalPlayer.PlayerGui.Teleport_UI.Frame.Pets.Visible = true

-- Helper Functions using GetFarm module
local function getPlayerFarm()
    local success, result = pcall(function()
        local get_farm = require(ReplicatedStorage.Modules.GetFarm)
        return get_farm(LocalPlayer)
    end)
    
    if success and result then
        return result
    else
        return nil
    end
end

local function getAllPlants()
    local plants = {}
    local playerFarm = getPlayerFarm()
    if playerFarm and playerFarm.Important and playerFarm.Important:FindFirstChild("Plants_Physical") then
        for _, plant in pairs(playerFarm.Important.Plants_Physical:GetChildren()) do
            if not table.find(plants, plant.Name) then
                table.insert(plants, plant.Name)
            end
        end
    end
    return plants
end

local function getAllPlantsInFarm()
    local plants = {}
    local playerFarm = getPlayerFarm()
    if playerFarm and playerFarm.Important and playerFarm.Important:FindFirstChild("Plants_Physical") then
        for _, plant in pairs(playerFarm.Important.Plants_Physical:GetChildren()) do
            table.insert(plants, plant)
        end
    end
    return plants
end

-- FIXED UUID-BASED PET DETECTION SYSTEM

-- 1. Get pet names from ActivePetUI using UUID and PET_TYPE.Text
local function getAllPetNames()
    local petNames = {}
    local activePetUI = LocalPlayer.PlayerGui:FindFirstChild("ActivePetUI")
    
    if activePetUI then
        local frame = activePetUI:FindFirstChild("Frame")
        if frame then
            local main = frame:FindFirstChild("Main")
            if main then
                local scrollingFrame = main:FindFirstChild("ScrollingFrame")
                if scrollingFrame then
                    
                    for _, child in pairs(scrollingFrame:GetChildren()) do
                        -- Check if this is a UUID frame (contains hyphens and is long enough)
                        if child:IsA("Frame") and string.find(child.Name, "-") and string.len(child.Name) > 20 then
                            
                            -- Look for PET_TYPE inside this UUID frame
                            local petType = child:FindFirstChild("PET_TYPE")
                            if petType and petType:IsA("TextLabel") and petType.Text ~= "" then
                                
                                -- Store both the pet name and UUID for later matching
                                local petData = {
                                    name = petType.Text,
                                    uuid = child.Name
                                }
                                
                                if not table.find(petNames, petType.Text) then
                                    table.insert(petNames, petType.Text)
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    
    return petNames
end

-- 2. Get UUID to pet name mapping from ActivePetUI
local function getUUIDToPetNameMapping()
    local mapping = {}
    local activePetUI = LocalPlayer.PlayerGui:FindFirstChild("ActivePetUI")
    
    if activePetUI then
        local frame = activePetUI:FindFirstChild("Frame")
        if frame then
            local main = frame:FindFirstChild("Main")
            if main then
                local scrollingFrame = main:FindFirstChild("ScrollingFrame")
                if scrollingFrame then
                    for _, child in pairs(scrollingFrame:GetChildren()) do
                        -- Check if this is a UUID frame
                        if child:IsA("Frame") and string.find(child.Name, "-") and string.len(child.Name) > 20 then
                            local petType = child:FindFirstChild("PET_TYPE")
                            if petType and petType:IsA("TextLabel") and petType.Text ~= "" then
                                mapping[child.Name] = petType.Text
                            end
                        end
                    end
                end
            end
        end
    end
    
    return mapping
end

-- 3. Get pets from PetsPhysical using proper BasePart/Part detection
local function getAvailablePetsInPhysical()
    local pets = {}
    local petsPhysical = workspace:FindFirstChild("PetsPhysical")
    local uuidMapping = getUUIDToPetNameMapping()
    
    if petsPhysical then
        for _, pet in pairs(petsPhysical:GetChildren()) do
            
            -- Check if it's a BasePart or Part and belongs to the player
            if (pet:IsA("BasePart") or pet:IsA("Part")) and pet:GetAttribute("OWNER") == LocalPlayer.Name then
                
                -- Get UUID from attributes
                local petUUID = pet:GetAttribute("UUID")
                if petUUID then
                    
                    -- Match UUID with ActivePetUI to get real pet name
                    local realPetName = uuidMapping[petUUID]
                    if realPetName then
                        if not table.find(pets, realPetName) then
                            table.insert(pets, realPetName)
                        end
                    end
                end
            end
        end
    end
    
    return pets
end

-- 4. Move pets to plant using UUID matching
local function movePetsToPlant(selectedPetName)
    local players = game:GetService("Players")
    local replicated_storage = game:GetService("ReplicatedStorage")
    local local_player = players.LocalPlayer

    local get_farm = require(replicated_storage.Modules.GetFarm)
    local local_farm = get_farm(local_player)

    if not local_farm or not local_farm.Important or not local_farm.Important:FindFirstChild("Plants_Physical") then
        return false
    end

    local position

    -- Find Bone Blossom position (or any plant)
    for _, v in next, local_farm.Important.Plants_Physical:GetChildren() do
        if v.Name == "Bone Blossom" then
            position = v:GetPivot().Position
            break
        end
    end

    if not position then
        -- If no Bone Blossom, use first available plant
        for _, v in next, local_farm.Important.Plants_Physical:GetChildren() do
            position = v:GetPivot().Position
            break
        end
    end

    if not position then
        return false
    end

    -- Get UUID mapping to match selected pet name to UUID
    local uuidMapping = getUUIDToPetNameMapping()
    local targetUUID = nil
    
    -- Find UUID for selected pet name
    for uuid, petName in pairs(uuidMapping) do
        if petName == selectedPetName then
            targetUUID = uuid
            break
        end
    end
    
    if not targetUUID and selectedPetName then
        return false
    end

    -- Move pets to the plant using UUID matching
    local movedCount = 0
    for _, v in next, workspace.PetsPhysical:GetChildren() do
        if (v:IsA("BasePart") or v:IsA("Part")) and v:GetAttribute("OWNER") == local_player.Name then
            local petUUID = v:GetAttribute("UUID")
            
            if petUUID then
                -- If no specific pet selected, move all pets
                -- If specific pet selected, only move that pet by UUID
                if not selectedPetName or petUUID == targetUUID then
                    -- Find the model inside the pet (if any)
                    local petModel = v:FindFirstChildOfClass("Model")
                    if petModel then
                        petModel:PivotTo(CFrame.new(position))
                    end
                    
                    -- Move the pet itself
                    v.Position = position
                    v.Anchored = false
                    movedCount = movedCount + 1
                    
                end
            end
        end
    end
    
    return movedCount > 0
end

-- NPC Submission Functions
local function submitToNPC(npcName)
    if npcName == "Channeller" then
        if ZenQuestRemoteEvent then
            ZenQuestRemoteEvent:FireServer("SubmitAllPlants")
            return true
        end
    elseif npcName == "Zen Shop" then
        if ZenAuraRemoteEvent then
            ZenAuraRemoteEvent:FireServer("SubmitAllPlants")
            return true
        end
    end
    return false
end

local function autoSubmitToNPCLoop()
    while autoSubmitToNPC do
        if selectedNPC then
            local success = submitToNPC(selectedNPC)
        end
        task.wait(0.1)
    end
end

local function getFruitsInBackpack()
    local fruits = {}
    local backpack = LocalPlayer:FindFirstChild("Backpack")
    if backpack then
        for _, tool in pairs(backpack:GetChildren()) do
            if tool:IsA("Tool") then
                if string.find(tool.Name, "%[") and string.find(tool.Name, "kg%]") then
                    table.insert(fruits, tool)
                end
            end
        end
    end
    return fruits
end

local function unequipCurrentTool()
    if LocalPlayer.Character then
        local currentTool = LocalPlayer.Character:FindFirstChildOfClass("Tool")
        if currentTool then
            currentTool.Parent = LocalPlayer.Backpack
            return true
        end
    end
    return false
end

local function equipRandomFruit()
    local fruits = getFruitsInBackpack()
    if #fruits > 0 then
        local randomFruit = fruits[math.random(1, #fruits)]
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            unequipCurrentTool()
            LocalPlayer.Character.Humanoid:EquipTool(randomFruit)
            task.wait(0.1)
            return randomFruit
        end
    end
    return nil
end

local function getEquippedFruit()
    if LocalPlayer.Character then
        for _, tool in pairs(LocalPlayer.Character:GetChildren()) do
            if tool:IsA("Tool") and string.find(tool.Name, "%[") and string.find(tool.Name, "kg%]") then
                return tool
            end
        end
    end
    return nil
end

local function safeTrowelInvoke(action, fruit, plant, cframe)
    if not TrowelRemote then
        return false, "TrowelRemote not found"
    end
    
    if not fruit or not plant then
        return false, "Missing fruit or plant"
    end
    
    local success, result = pcall(function()
        if action == "Pickup" then
            return TrowelRemote:InvokeServer(action, fruit, plant)
        elseif action == "Place" then
            if not cframe then
                return nil
            end
            return TrowelRemote:InvokeServer(action, fruit, plant, cframe)
        else
            return nil
        end
    end)
    
    if success then
        return true, result
    else
        return false, result
    end
end

-- Other helper functions
local function getOwnFarmSpawnCFrame()
    local playerFarm = getPlayerFarm()
    if playerFarm then
        local spawnPoint = playerFarm:FindFirstChild("Spawn_Point")
        if spawnPoint and spawnPoint:IsA("BasePart") then
            return spawnPoint.CFrame
        end
    end
    return nil
end

local function submitSummer()
    while autoSubmit do
        game:GetService("ReplicatedStorage")
            :WaitForChild("GameEvents")
            :WaitForChild("SummerHarvestRemoteEvent")
            :FireServer("SubmitHeldPlant")
        task.wait(0.1)
    end
end

local function submitAllHarvestFruit()
    while autoSubmitAllHarvest do
        game:GetService("ReplicatedStorage")
            :WaitForChild("GameEvents")
            :WaitForChild("SummerHarvestRemoteEvent")
            :FireServer("SubmitAllPlants")
        task.wait(0.1)
    end
end

local function getFruitCount()
    local bag = LocalPlayer.Backpack
    local count = 0
    for _, v in pairs(bag:GetChildren()) do
        if v:FindFirstChild("Weight") and v:FindFirstChild("Variant") then
            count = count + 1
        end
    end
    return count
end

local function removeHighlight()
    if currentHighlight then
        currentHighlight:Destroy()
        currentHighlight = nil
    end
    if currentBillboard then
        currentBillboard:Destroy()
        currentBillboard = nil
    end
end

local function highlightBiggestFruit()
    local farm = getPlayerFarm()
    if not farm then
        removeHighlight()
        lastBiggest = nil
        return
    end

    local plants = farm:FindFirstChild("Important") and farm.Important:FindFirstChild("Plants_Physical")
    if not plants then
        removeHighlight()
        lastBiggest = nil
        return
    end

    local biggest, maxWeight = nil, -math.huge
    for _, fruit in ipairs(plants:GetChildren()) do
        local weightObj = fruit:FindFirstChild("Weight")
        if weightObj and tonumber(weightObj.Value) and tonumber(weightObj.Value) > maxWeight then
            biggest = fruit
            maxWeight = tonumber(weightObj.Value)
        end
    end

    if biggest ~= lastBiggest then
        removeHighlight()
        lastBiggest = biggest
        if biggest and biggest:IsA("Model") then
            local highlight = Instance.new("Highlight")
            highlight.FillColor = Color3.fromRGB(0, 255, 0)
            highlight.OutlineColor = Color3.fromRGB(0, 150, 0)
            highlight.FillTransparency = 0.3
            highlight.OutlineTransparency = 0
            highlight.Adornee = biggest
            highlight.Parent = biggest
            currentHighlight = highlight

            local head = biggest:FindFirstChildWhichIsA("BasePart")
            if head then
                local bb = Instance.new("BillboardGui")
                bb.Size = UDim2.new(0, 100, 0, 40)
                bb.AlwaysOnTop = true
                bb.StudsOffset = Vector3.new(0, 3, 0)
                bb.Adornee = head
                bb.Parent = head

                local label = Instance.new("TextLabel")
                label.Size = UDim2.new(1, 0, 1, 0)
                label.BackgroundTransparency = 1
                label.TextColor3 = Color3.fromRGB(0, 255, 0)
                label.TextStrokeTransparency = 0.2
                label.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
                label.TextScaled = true
                label.Font = Enum.Font.FredokaOne
                label.Text = "Weight: " .. string.format("%.2f", maxWeight) .. "kg"
                label.Parent = bb

                currentBillboard = bb
            end
        end
    end
end

local function savePosition()
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if hrp then
        savedPosition = hrp.Position
        lib:Notification('Success', 'Position saved!', 3)
    else
        lib:Notification('Error', 'Could not save position (HumanoidRootPart missing).', 3)
    end
end

local function teleportTo(pos)
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then
        lib:Notification('Error', 'Could not teleport (HumanoidRootPart missing).', 3)
        return
    end
    if typeof(pos) == "Vector3" then
        hrp.CFrame = CFrame.new(pos)
    elseif typeof(pos) == "string" then
        local x, y, z = string.match(pos, "Vector3%s*%(([^,]+),%s*([^,]+),%s*([^)]+)%)")
        if x and y and z then
            hrp.CFrame = CFrame.new(tonumber(x), tonumber(y), tonumber(z))
        end
    end
end

local function sellInventory()
    ReplicatedStorage:WaitForChild("GameEvents"):WaitForChild("Sell_Inventory"):FireServer()
    lib:Notification('Success', 'Inventory sold!', 3)
end

local function tpAndSell()
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if hrp then
        local returnCFrame = getOwnFarmSpawnCFrame()
        hrp.CFrame = CFrame.new(
            86.5854721, 2.76619363, 0.426784277,
            0, 0, -1,
            0, 1, 0,
            1, 0, 0
        )
        task.wait(0.2)
        ReplicatedStorage:WaitForChild("GameEvents"):WaitForChild("Sell_Inventory"):FireServer()
        lib:Notification('Success', 'Teleported and sold inventory!', 3)
        if returnCFrame then
            task.wait(0.2)
            hrp.CFrame = returnCFrame
            lib:Notification('Success', 'Returned to your garden spawn point!', 3)
        else
            lib:Notification('Warning', 'Could not find your garden spawn point!', 3)
        end
    else
        lib:Notification('Error', 'HumanoidRootPart not found!', 3)
    end
end

-- FIXED: Mutasi collection filter function based on attributes
local function mutasiCollectFilter(item, selectedMutasi)
    -- Check if item exists and has attributes
    if not item then return false end
    
    -- If no specific mutasi selected, collect all items with any mutasi
    if #selectedMutasi == 0 then
        -- Check if item has any mutasi attribute set to true
        for _, mutasi in pairs(validMutasi) do
            local attributeValue = item:GetAttribute(mutasi)
            if attributeValue == true then
                return true
            end
        end
        return false
    end
    
    -- If specific mutasi selected, check if item has any of the selected ones
    for _, mutasi in pairs(selectedMutasi) do
        local attributeValue = item:GetAttribute(mutasi)
        if attributeValue == true then
            return true
        end
    end
    
    return false
end

-- SEED BUYING SECTION
sections.SeedBuyer:AddDropdown("SeedSelect", {
    Title = "Select Seeds to Buy",
    Description = "Choose which seeds you want to auto buy",
    Options = validSeeds,
    Default = {},
    PlaceHolder = "Select seeds",
    Multiple = true,
    Callback = function(selected)
        selectedSeeds = selected
        if #selectedSeeds > 0 then
            local seedList = table.concat(selectedSeeds, ", ")
            lib:Notification('Info', 'Selected seeds: ' .. seedList, 5)
        else
            lib:Notification('Info', 'No seeds selected', 3)
        end
    end
})

sections.SeedBuyer:AddButton({
    Title = "Buy Selected Seeds Once",
    Description = "Buy all selected seeds one time each",
    Callback = function()
        if buyEvent and #selectedSeeds > 0 then
            local count = 0
            for _, seed in ipairs(selectedSeeds) do
                buyEvent:FireServer(seed)
                count = count + 1
                task.wait(0.01)
            end
            lib:Notification('Success', 'Bought ' .. count .. ' different seeds!', 3)
        else
            lib:Notification('Error', 'No seeds selected or buy event not found', 3)
        end
    end,
})

sections.SeedBuyer:AddToggle("AutoBuySelected", {
    Title = "Auto Buy Selected Seeds Only",
    Default = false,
    Description = "Continuously buy ONLY the seeds you selected from dropdown",
    Callback = function(value)
        autoBuyingSelected = value
        if value then
            if #selectedSeeds > 0 then
                local seedList = table.concat(selectedSeeds, ", ")
                lib:Notification('Success', 'Auto buying selected seeds: ' .. seedList, 5)
                task.spawn(function()
                    while autoBuyingSelected do
                        if buyEvent and #selectedSeeds > 0 then
                            for _, seed in ipairs(selectedSeeds) do
                                if not autoBuyingSelected then break end
                                buyEvent:FireServer(seed)
                                task.wait(0.01)
                            end
                        end
                        task.wait(0.01)
                    end
                end)
            else
                lib:Notification('Warning', 'No seeds selected! Please select seeds from dropdown first.', 3)
                autoBuyingSelected = false
            end
        else
            lib:Notification('Info', 'Auto buy selected seeds disabled', 3)
        end
    end,
})

sections.SeedBuyer:AddToggle("AutoBuyAll", {
    Title = "Auto Buy All Seeds",
    Default = false,
    Description = "Continuously buy ALL available seeds (ignores selection)",
    Callback = function(value)
        autoBuyingAll = value
        if value then
            lib:Notification('Success', 'Auto buying ALL ' .. #validSeeds .. ' seeds enabled', 3)
            task.spawn(function()
                while autoBuyingAll do
                    for _, seed in ipairs(validSeeds) do
                        if not autoBuyingAll then break end
                        if buyEvent then
                            buyEvent:FireServer(seed)
                        end
                        task.wait(0.01)
                    end
                    task.wait(0.01)
                end
            end)
        else
            lib:Notification('Info', 'Auto buy all seeds disabled', 3)
        end
    end,
})

sections.SeedBuyer:AddButton({
    Title = "Clear Selected Seeds",
    Description = "Clear all selected seeds",
    Callback = function()
        selectedSeeds = {}
        lib:Notification('Info', 'All selected seeds cleared', 3)
    end,
})

-- GEAR BUYING SECTION
sections.GearBuyer:AddDropdown("GearSelect", {
    Title = "Select Gears to Buy",
    Description = "Choose which gears you want to auto buy",
    Options = validGears,
    Default = {},
    PlaceHolder = "Select gears",
    Multiple = true,
    Callback = function(selected)
        selectedGears = selected
        if #selectedGears > 0 then
            local gearList = table.concat(selectedGears, ", ")
            lib:Notification('Info', 'Selected gears: ' .. gearList, 5)
        else
            lib:Notification('Info', 'No gears selected', 3)
        end
    end
})

sections.GearBuyer:AddButton({
    Title = "Buy Selected Gears Once",
    Description = "Buy all selected gears one time each",
    Callback = function()
        if buyGearEvent and #selectedGears > 0 then
            local count = 0
            for _, gear in ipairs(selectedGears) do
                buyGearEvent:FireServer(gear)
                count = count + 1
                task.wait(0.01)
            end
            lib:Notification('Success', 'Bought ' .. count .. ' different gears!', 3)
        else
            lib:Notification('Error', 'No gears selected or buy gear event not found', 3)
        end
    end,
})

sections.GearBuyer:AddToggle("AutoBuySelectedGear", {
    Title = "Auto Buy Selected Gears Only",
    Default = false,
    Description = "Continuously buy ONLY the gears you selected from dropdown",
    Callback = function(value)
        autoBuyingSelectedGear = value
        if value then
            if #selectedGears > 0 then
                local gearList = table.concat(selectedGears, ", ")
                lib:Notification('Success', 'Auto buying selected gears: ' .. gearList, 5)
                task.spawn(function()
                    while autoBuyingSelectedGear do
                        if buyGearEvent and #selectedGears > 0 then
                            for _, gear in ipairs(selectedGears) do
                                if not autoBuyingSelectedGear then break end
                                buyGearEvent:FireServer(gear)
                                task.wait(0.01)
                            end
                        end
                        task.wait(0.01)
                    end
                end)
            else
                lib:Notification('Warning', 'No gears selected! Please select gears from dropdown first.', 3)
                autoBuyingSelectedGear = false
            end
        else
            lib:Notification('Info', 'Auto buy selected gears disabled', 3)
        end
    end,
})

sections.GearBuyer:AddToggle("AutoBuyAllGears", {
    Title = "Auto Buy All Gears",
    Default = false,
    Description = "Continuously buy ALL available gears (ignores selection)",
    Callback = function(value)
        autoBuyingAllGears = value
        if value then
            lib:Notification('Success', 'Auto buying ALL ' .. #validGears .. ' gears enabled', 3)
            task.spawn(function()
                while autoBuyingAllGears do
                    for _, gear in ipairs(validGears) do
                        if not autoBuyingAllGears then break end
                        if buyGearEvent then
                            buyGearEvent:FireServer(gear)
                        end
                        task.wait(0.01)
                    end
                    task.wait(0.01)
                end
            end)
        else
            lib:Notification('Info', 'Auto buy all gears disabled', 3)
        end
    end,
})

sections.GearBuyer:AddButton({
    Title = "Clear Selected Gears",
    Description = "Clear all selected gears",
    Callback = function()
        selectedGears = {}
        lib:Notification('Info', 'All selected gears cleared', 3)
    end,
})

-- Teleport Section
sections.Teleport:AddButton({
    Title = "Save Position",
    Callback = savePosition
})

sections.Teleport:AddButton({
    Title = "Teleport to Saved Position",
    Callback = function()
        if savedPosition then
            teleportTo(savedPosition)
            lib:Notification('Success', 'Teleported to saved position!', 3)
        else
            lib:Notification('Warning', 'No position saved yet.', 3)
        end
    end
})

-- Fruit Management Section
sections.Fruit:AddSlider("FruitThreshold", {
    Title = "Fruit Threshold",
    Description = "Number of fruits before auto-selling",
    Default = 10,
    Min = 1,
    Max = 200,
    Increment = 1,
    Callback = function(value)
        fruitThreshold = value
    end,
})

sections.Fruit:AddToggle("AutoSell", {
    Title = "Auto Sell",
    Default = false,
    Description = "Automatically teleport and sell when threshold reached",
    Callback = function(state)
        autoSell = state
        if autoSell then
            lib:Notification('Success', 'Auto TP & Sell enabled.', 3)
            task.spawn(function()
                while autoSell do
                    if getFruitCount() >= fruitThreshold then
                        tpAndSell()
                        task.wait(2)
                    end
                    task.wait(1)
                end
            end)
        else
            lib:Notification('Info', 'Auto TP & Sell disabled.', 3)
        end
    end,
})

sections.Fruit:AddToggle("ShowBiggest", {
    Title = "Show Biggest Fruit",
    Default = false,
    Description = "Highlight the biggest fruit in your farm",
    Callback = function(state)
        highlightToggle = state
        if highlightToggle then
            highlightBiggestFruit()
            conn = RunService.RenderStepped:Connect(function()
                if highlightToggle then
                    highlightBiggestFruit()
                end
            end)
        else
            if conn then conn:Disconnect() end
            removeHighlight()
            lastBiggest = nil
        end
    end,
})

sections.Fruit:AddButton({
    Title = "Sell Inventory",
    Callback = sellInventory
})

sections.Fruit:AddButton({
    Title = "TP, Sell, Return",
    Callback = function()
        savePosition()
        local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hrp then return end
        hrp.CFrame = CFrame.new(86.57965850830078, 2.999999761581421, 0.4267919063568115)
        task.wait(0.25)
        sellInventory()
        task.wait(0.2)
        if savedPosition then
            teleportTo(savedPosition)
            lib:Notification('Success', 'Returned to saved position!', 3)
        end
    end
})

-- FIXED: Mutasi Collection Section
sections.AutoHarvest:AddDropdown("MutasiSelect", {
    Title = "Select Mutasi to Collect",
    Description = "Choose which mutasi you want to collect (leave empty for all mutasi)",
    Options = validMutasi,
    Default = {},
    PlaceHolder = "Select mutasi (optional)",
    Multiple = true,
    Callback = function(selected)
        selectedMutasi = selected
        if #selectedMutasi > 0 then
            local mutasiList = table.concat(selectedMutasi, ", ")
            lib:Notification('Info', 'Selected mutasi: ' .. mutasiList, 5)
        else
            lib:Notification('Info', 'No mutasi selected - will collect all mutasi fruits', 3)
        end
    end
})

sections.AutoHarvest:AddToggle("MutasiAutoCollect", {
    Title = "Auto Collect Mutasi",
    Default = false,
    Description = "Automatically collect fruits with selected mutasi based on attributes",
    Callback = function(state)
        mutasiCollectEnabled = state
        if mutasiCollectEnabled then
            lib:Notification('Success', 'Auto Collect Mutasi enabled!', 3)
            task.spawn(function()
                while mutasiCollectEnabled do
                    local players = game:GetService("Players")
                    local replicated_storage = game:GetService("ReplicatedStorage")
                    local get_farm = require(replicated_storage.Modules.GetFarm)
                    local byte_net_reliable = replicated_storage:WaitForChild("ByteNetReliable")
                    local buffer = buffer.fromstring("\1\1\0\1")

                    local local_player = players.LocalPlayer
                    local farm = get_farm(local_player)
                    if not farm or not farm.Important or not farm.Important:FindFirstChild("Plants_Physical") then
                        lib:Notification('Warning', 'Could not find your farm plants.', 3)
                        break
                    end

                    local collectedCount = 0
                    for _, plant in next, farm.Important.Plants_Physical:GetChildren() do
                        -- Check plant itself for mutasi attributes
                        if mutasiCollectFilter(plant, selectedMutasi) then
                            pcall(function()
                                byte_net_reliable:FireServer(buffer, { plant })
                                collectedCount = collectedCount + 1
                            end)
                        end
                        
                        -- Check fruits inside plant for mutasi attributes
                        if plant:FindFirstChild("Fruits") then
                            for _, fruit in pairs(plant.Fruits:GetChildren()) do
                                if mutasiCollectFilter(fruit, selectedMutasi) then
                                    pcall(function()
                                        byte_net_reliable:FireServer(buffer, { fruit })
                                        collectedCount = collectedCount + 1
                                    end)
                                end
                            end
                        end
                    end
                    
                    if collectedCount > 0 then
                    end
                    
                    task.wait(3)
                end
                lib:Notification('Info', 'Auto Collect Mutasi disabled!', 3)
            end)
        else
            lib:Notification('Info', 'Auto Collect Mutasi disabled!', 3)
        end
    end,
})

sections.AutoHarvest:AddButton({
    Title = "Clear Selected Mutasi",
    Description = "Clear all selected mutasi (will collect all mutasi fruits)",
    Callback = function()
        selectedMutasi = {}
        lib:Notification('Info', 'All selected mutasi cleared - will collect all mutasi fruits', 3)
    end,
})

-- UI Controls Section
sections.UIControls:AddButton({
    Title = "Seed Shop",
    Callback = function()
        local gui = LocalPlayer.PlayerGui
        gui.Seed_Shop.Enabled = true
        gui.Gear_Shop.Enabled = false
        gui.HoneyEventShop_UI.Enabled = false
        gui.CosmeticShop_UI.Enabled = false
        lib:Notification('Info', 'Seed Shop opened', 3)
    end,
})

sections.UIControls:AddButton({
    Title = "Gear Shop",
    Callback = function()
        local gui = LocalPlayer.PlayerGui
        gui.Seed_Shop.Enabled = false
        gui.Gear_Shop.Enabled = true
        gui.HoneyEventShop_UI.Enabled = false
        gui.CosmeticShop_UI.Enabled = false
        lib:Notification('Info', 'Gear Shop opened', 3)
    end,
})
sections.UIControls:AddButton({
    Title = "Hide All Shops",
    Callback = function()
        local gui = LocalPlayer.PlayerGui
        gui.Seed_Shop.Enabled = false
        gui.Gear_Shop.Enabled = false
        gui.HoneyEventShop_UI.Enabled = false
        gui.CosmeticShop_UI.Enabled = false
        lib:Notification('Info', 'All shops hidden', 3)
    end,
})

-- NPC Submission Section (moved to Event tab)
sections.NPCSubmission:AddDropdown("NPCSelect", {
    Title = "Select Give to NPC",
    Description = "Choose which NPC to submit plants to",
    Options = {"Channeller", "Zen Shop"},
    Default = "",
    PlaceHolder = "Select NPC",
    Multiple = false,
    Callback = function(selected)
        if type(selected) == "table" and #selected > 0 then
            selectedNPC = selected[1]
        elseif type(selected) == "string" then
            selectedNPC = selected
        else
            selectedNPC = nil
        end
        
        if selectedNPC then
            lib:Notification('Info', 'Selected NPC: ' .. selectedNPC, 3)
        else
            lib:Notification('Info', 'No NPC selected', 3)
        end
    end
})

sections.NPCSubmission:AddToggle("AutoSubmitNPC", {
    Title = "Auto Submit to NPC",
    Default = false,
    Description = "Automatically submit plants to selected NPC",
    Callback = function(value)
        autoSubmitToNPC = value
        if value then
            if selectedNPC then
                task.spawn(autoSubmitToNPCLoop)
            else
                lib:Notification('Warning', 'Please select an NPC first!', 3)
                autoSubmitToNPC = false
            end
        else
            lib:Notification('Info', 'Auto submit to NPC disabled!', 3)
        end
    end,
})

-- Config System
FlagsManager:SetLibrary(lib)
FlagsManager:SetIgnoreIndexes({})
FlagsManager:SetFolder("Avantrix/GAG")
FlagsManager:InitSaveSystem(tabs.Settings)
